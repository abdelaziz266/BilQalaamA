<div class="content pb-0">
    <!-- Page Header -->
    <div class="d-flex align-items-center justify-content-between gap-2 mb-4 flex-wrap">
        <div>
            <h4 class="mb-1">الطلاب <span class="badge badge-soft-primary ms-2">{{totalCount}}</span></h4>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 p-0">
                    <li class="breadcrumb-item"><a routerLink="/">الرئيسية</a></li>
                    <li class="breadcrumb-item active" aria-current="page">الطلاب</li>
                </ol>
            </nav>
        </div>
        <div class="gap-2 d-flex align-items-center flex-wrap">
            <button class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvas_add" (click)="resetForm()">
                <i class="ti ti-square-rounded-plus-filled me-1"></i>إضافة طالب جديد
            </button>
        </div>
    </div>

    <!-- Table Card -->
    <div class="card border-0 rounded-0">
        <div class="card-header d-flex align-items-center justify-content-between gap-2 flex-wrap">
            <div class="d-flex align-items-center gap-2 flex-nowrap">
                <p-multiselect [options]="families" 
                    [(ngModel)]="selectedFamilyIds" 
                    optionLabel="familyName" 
                    optionValue="id" 
                    placeholder="فلتر حسب العائلة" 
                    class="form-control" 
                    [filter]="true"
                    [showClear]="true"
                    (onChange)="onFilterChange()"
                    [style]="{'min-width': '220px'}">
                </p-multiselect>
                <p-multiselect [options]="teachers" 
                    [(ngModel)]="selectedTeacherIds" 
                    optionLabel="teacherName" 
                    optionValue="id" 
                    placeholder="فلتر حسب المعلم" 
                    class="form-control" 
                    [filter]="true"
                    [showClear]="true"
                    (onChange)="onFilterChange()"
                    [style]="{'min-width': '220px'}">
                </p-multiselect>
                <button class="btn btn-outline-secondary btn-sm text-nowrap" 
                    *ngIf="(selectedFamilyIds && selectedFamilyIds.length > 0) || (selectedTeacherIds && selectedTeacherIds.length > 0)" 
                    (click)="clearFilters()">
                    <i class="ti ti-x me-1"></i>مسح الفلاتر
                </button>
                
            </div>
            <div class="search-box">
                <input type="search" class="form-control" placeholder="بحث...">
                <i class="ti ti-search search-icon"></i>
            </div>
        </div>
        <div class="card-body d-flex flex-column">
            <!-- No Data State -->
            <div *ngIf="students.length === 0" class="text-center py-5">
                <i class="ti ti-database-off fs-1 text-muted"></i>
                <p class="mt-2 text-muted">لم يتم العثور على طلاب</p>
            </div>

            <!-- Table -->
            <div class="table-responsive table-container" *ngIf="students.length > 0">
                <table class="table table-striped mb-0" matSort (matSortChange)="sortData($event)">
                    <thead>
                        <tr>
                            <th mat-sort-header="studentName">اسم الطالب</th>
                            <th mat-sort-header="email">البريد الإلكتروني</th>
                            <th mat-sort-header="phoneNumber">الهاتف</th>
                            <th mat-sort-header="familyName">العائلة</th>
                            <th mat-sort-header="teacherName">المعلم</th>
                            <th mat-sort-header="hourlyRate">سعر الساعة</th>
                            <th>الإجراء</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let data of students">
                            <td>{{data.studentName}}</td>
                            <td>{{data.email}}</td>
                            <td>{{data.phoneNumber}}</td>
                            <td>{{data.familyName || '---'}}</td>
                            <td>{{data.teacherName || '---'}}</td>
                            <td>{{data.hourlyRate}} {{getCurrencyLabel(data.currency)}}</td>
                            <td>
                                <div class="dropdown table-action">
                                    <a href="javascript:void(0);" class="action-icon btn btn-xs shadow btn-icon btn-outline-light"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="ti ti-dots-vertical"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <a class="dropdown-item" href="javascript:void(0);" data-bs-toggle="offcanvas"
                                            data-bs-target="#offcanvas_edit" (click)="openEditModal(data.id)">
                                            <i class="ti ti-edit text-blue me-1"></i>تعديل
                                        </a>
                                        <a class="dropdown-item" href="javascript:void(0);" data-bs-toggle="modal"
                                            data-bs-target="#delete_student" (click)="openDeleteModal(data.id)">
                                            <i class="ti ti-trash text-blue me-1"></i>حذف
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <app-custom-pagination 
                [rowCount]="rowCount" 
                [pageNumber]="pageNumber" 
                [pagesCount]="pagesCount"
                (pageChange)="onPageChange($event)">
            </app-custom-pagination>
        </div>
    </div>
</div>

<!-- Add Student Offcanvas -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="offcanvas_add" #offcanvasAdd>
    <div class="offcanvas-header border-bottom">
        <h5 class="fw-semibold">إضافة طالب جديد</h5>
    </div>
    <div class="offcanvas-body">
        <form [formGroup]="studentForm" (ngSubmit)="submitForm()">
            <div class="row">
                <div class="col-12 mb-3">
                    <label class="form-label">الاسم الكامل <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" formControlName="fullName" dir="auto">
                    <div class="text-danger mt-1" *ngIf="fullName.invalid && (fullName.dirty || fullName.touched)">
                        <small *ngIf="fullName.errors?.['required']">الاسم الكامل مطلوب.</small>
                        <small *ngIf="fullName.errors?.['minlength']">الاسم يجب أن يكون 3 أحرف على الأقل.</small>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label">البريد الإلكتروني <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" formControlName="email" dir="auto">
                    <div class="text-danger mt-1" *ngIf="email.invalid && (email.dirty || email.touched)">
                        <small *ngIf="email.errors?.['required']">البريد الإلكتروني مطلوب.</small>
                        <small *ngIf="email.errors?.['email'] || email.errors?.['pattern']">صيغة البريد الإلكتروني غير صحيحة (يجب أن ينتهي بـ .com).</small>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">رقم الهاتف <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" formControlName="phoneNumber" maxlength="11" dir="auto">
                    <div class="text-danger mt-1" *ngIf="phoneNumber.invalid && (phoneNumber.dirty || phoneNumber.touched)">
                        <small *ngIf="phoneNumber.errors?.['required']">رقم الهاتف مطلوب.</small>
                        <small *ngIf="phoneNumber.errors?.['pattern']">رقم الهاتف يجب أن يبدأ بـ 010 أو 011 أو 012 ويتكون من 11 رقم.</small>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">كلمة المرور <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <input [type]="passwordVisible ? 'text' : 'password'" class="form-control" formControlName="password" dir="auto">
                        <button class="btn btn-outline-light border" type="button" (click)="togglePasswordVisible()">
                            <i class="ti" [ngClass]="passwordVisible ? 'ti-eye' : 'ti-eye-off'"></i>
                        </button>
                    </div>
                    <div class="text-danger mt-1" *ngIf="password.invalid && (password.dirty || password.touched)">
                        <small *ngIf="password.errors?.['required']">كلمة المرور مطلوبة.</small>
                        <small *ngIf="password.errors?.['minlength']">كلمة المرور يجب أن تكون 6 أحرف على الأقل.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">تأكيد كلمة المرور <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <input [type]="confirmPasswordVisible ? 'text' : 'password'" class="form-control" formControlName="confirmPassword" dir="auto">
                        <button class="btn btn-outline-light border" type="button" (click)="toggleConfirmPasswordVisible()">
                            <i class="ti" [ngClass]="confirmPasswordVisible ? 'ti-eye' : 'ti-eye-off'"></i>
                        </button>
                    </div>
                    <div class="text-danger mt-1" *ngIf="confirmPassword.invalid && (confirmPassword.dirty || confirmPassword.touched)">
                        <small *ngIf="confirmPassword.errors?.['required']">تأكيد كلمة المرور مطلوب.</small>
                        <small *ngIf="confirmPassword.errors?.['passwordMismatch']">كلمات المرور غير متطابقة.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">العائلة <span class="text-danger">*</span></label>
                    <p-select [options]="families" 
                        formControlName="familyId" optionLabel="familyName" optionValue="id" 
                        placeholder="اختر العائلة" class="form-control w-100" [filter]="true"></p-select>
                    <div class="text-danger mt-1" *ngIf="familyId.invalid && (familyId.dirty || familyId.touched)">
                        <small *ngIf="familyId.errors?.['required']">العائلة مطلوبة.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">المعلم <span class="text-danger">*</span></label>
                    <p-select [options]="teachers" 
                        formControlName="teacherId" optionLabel="teacherName" optionValue="id" 
                        placeholder="اختر المعلم" class="form-control w-100" [filter]="true"></p-select>
                    <div class="text-danger mt-1" *ngIf="teacherId.invalid && (teacherId.dirty || teacherId.touched)">
                        <small *ngIf="teacherId.errors?.['required']">المعلم مطلوب.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">سعر الساعة <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" formControlName="hourlyRate" dir="auto">
                    <div class="text-danger mt-1" *ngIf="hourlyRate.invalid && (hourlyRate.dirty || hourlyRate.touched)">
                        <small *ngIf="hourlyRate.errors?.['required']">سعر الساعة مطلوب.</small>
                        <small *ngIf="hourlyRate.errors?.['min']">سعر الساعة يجب أن يكون أكبر من 0.</small>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">العملة <span class="text-danger">*</span></label>
                    <p-select [options]="currencyOptions" 
                        formControlName="currency" optionLabel="label" optionValue="value" 
                        class="form-control w-100"></p-select>
                    <div class="text-danger mt-1" *ngIf="currency.invalid && (currency.dirty || currency.touched)">
                        <small *ngIf="currency.errors?.['required']">العملة مطلوبة.</small>
                    </div>
                </div>
                <div class="col-12 text-end mt-3">
                    <button type="button" class="btn btn-light mx-2" data-bs-dismiss="offcanvas">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ الطالب</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Student Offcanvas -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="offcanvas_edit" #offcanvasEdit>
    <div class="offcanvas-header border-bottom">
        <h5 class="fw-semibold">تعديل الطالب</h5>
    </div>
    <div class="offcanvas-body">
        <form [formGroup]="studentForm" (ngSubmit)="submitForm()">
            <div class="row">
                <div class="col-12 mb-3">
                    <label class="form-label">الاسم الكامل <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" formControlName="fullName" dir="auto">
                    <div class="text-danger mt-1" *ngIf="fullName.invalid && (fullName.dirty || fullName.touched)">
                        <small *ngIf="fullName.errors?.['required']">الاسم الكامل مطلوب.</small>
                        <small *ngIf="fullName.errors?.['minlength']">الاسم يجب أن يكون 3 أحرف على الأقل.</small>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label">البريد الإلكتروني <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" formControlName="email" dir="auto" [readonly]="true">
                    <div class="text-danger mt-1" *ngIf="email.invalid && (email.dirty || email.touched)">
                        <small *ngIf="email.errors?.['required']">البريد الإلكتروني مطلوب.</small>
                        <small *ngIf="email.errors?.['email'] || email.errors?.['pattern']">صيغة البريد الإلكتروني غير صحيحة (يجب أن ينتهي بـ .com).</small>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">رقم الهاتف <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" formControlName="phoneNumber" maxlength="11" dir="auto">
                    <div class="text-danger mt-1" *ngIf="phoneNumber.invalid && (phoneNumber.dirty || phoneNumber.touched)">
                        <small *ngIf="phoneNumber.errors?.['required']">رقم الهاتف مطلوب.</small>
                        <small *ngIf="phoneNumber.errors?.['pattern']">رقم الهاتف يجب أن يبدأ بـ 010 أو 011 أو 012 ويتكون من 11 رقم.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">كلمة المرور (اختياري)</label>
                    <div class="input-group">
                        <input [type]="passwordVisible ? 'text' : 'password'" class="form-control" formControlName="password" dir="auto">
                        <button class="btn btn-outline-light border" type="button" (click)="togglePasswordVisible()">
                            <i class="ti" [ngClass]="passwordVisible ? 'ti-eye' : 'ti-eye-off'"></i>
                        </button>
                    </div>
                    <div class="text-danger mt-1" *ngIf="password.invalid && (password.dirty || password.touched)">
                        <small *ngIf="password.errors?.['minlength']">كلمة المرور يجب أن تكون 6 أحرف على الأقل.</small>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">تأكيد كلمة المرور</label>
                    <div class="input-group">
                        <input [type]="confirmPasswordVisible ? 'text' : 'password'" class="form-control" formControlName="confirmPassword" dir="auto">
                        <button class="btn btn-outline-light border" type="button" (click)="toggleConfirmPasswordVisible()">
                            <i class="ti" [ngClass]="confirmPasswordVisible ? 'ti-eye' : 'ti-eye-off'"></i>
                        </button>
                    </div>
                    <div class="text-danger mt-1" *ngIf="confirmPassword.invalid && (confirmPassword.dirty || confirmPassword.touched)">
                        <small *ngIf="confirmPassword.errors?.['passwordMismatch']">كلمات المرور غير متطابقة.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">العائلة <span class="text-danger">*</span></label>
                    <p-select [options]="families" 
                        formControlName="familyId" optionLabel="familyName" optionValue="id" 
                        placeholder="اختر العائلة" class="form-control w-100" [filter]="true"></p-select>
                    <div class="text-danger mt-1" *ngIf="familyId.invalid && (familyId.dirty || familyId.touched)">
                        <small *ngIf="familyId.errors?.['required']">العائلة مطلوبة.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">المعلم <span class="text-danger">*</span></label>
                    <p-select [options]="teachers" 
                        formControlName="teacherId" optionLabel="teacherName" optionValue="id" 
                        placeholder="اختر المعلم" class="form-control w-100" [filter]="true"></p-select>
                    <div class="text-danger mt-1" *ngIf="teacherId.invalid && (teacherId.dirty || teacherId.touched)">
                        <small *ngIf="teacherId.errors?.['required']">المعلم مطلوب.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">سعر الساعة <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" formControlName="hourlyRate" dir="auto">
                    <div class="text-danger mt-1" *ngIf="hourlyRate.invalid && (hourlyRate.dirty || hourlyRate.touched)">
                        <small *ngIf="hourlyRate.errors?.['required']">سعر الساعة مطلوب.</small>
                        <small *ngIf="hourlyRate.errors?.['min']">سعر الساعة يجب أن يكون أكبر من 0.</small>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">العملة <span class="text-danger">*</span></label>
                    <p-select [options]="currencyOptions" 
                        formControlName="currency" optionLabel="label" optionValue="value" 
                        class="form-control w-100"></p-select>
                    <div class="text-danger mt-1" *ngIf="currency.invalid && (currency.dirty || currency.touched)">
                        <small *ngIf="currency.errors?.['required']">العملة مطلوبة.</small>
                    </div>
                </div>
                
                <div class="col-12 text-end mt-3">
                    <button type="button" class="btn btn-light mx-2" data-bs-dismiss="offcanvas">إلغاء</button>
                    <button type="submit" class="btn btn-primary" [disabled]="studentForm.invalid">تحديث الطالب</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="delete_student">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <span class="avatar avatar-xl badge-soft-danger border-0 text-danger rounded-circle">
                        <i class="ti ti-trash fs-24"></i>
                    </span>
                </div>
                <h5 class="mb-1">تأكيد الحذف</h5>
                <p class="mb-3">هل أنت متأكد أنك تريد حذف هذا الطالب؟</p>
                <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-sm btn-light me-2 w-100" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-sm btn-primary w-100" data-bs-dismiss="modal" (click)="onDeleteStudent()">نعم، احذف</button>
                </div>
            </div>
        </div>
    </div>
</div>
