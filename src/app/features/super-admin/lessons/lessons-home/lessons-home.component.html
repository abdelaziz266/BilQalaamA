<div class="content pb-0">
    <!-- Page Header -->
    <div class="d-flex align-items-center justify-content-between gap-2 mb-4 flex-wrap">
        <div>
            <h4 class="mb-1">الدروس <span class="badge badge-soft-primary ms-2">{{totalCount}}</span></h4>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 p-0">
                    <li class="breadcrumb-item"><a routerLink="/">الرئيسية</a></li>
                    <li class="breadcrumb-item active" aria-current="page">الدروس</li>
                </ol>
            </nav>
        </div>
        <div class="gap-2 d-flex align-items-center flex-wrap">
            <button class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvas_add"
                (click)="resetForm()">
                <i class="ti ti-square-rounded-plus-filled me-1"></i>إضافة درس جديد
            </button>
        </div>
    </div>

    <!-- Table Card -->
    <div class="card border-0 rounded-0">
        <!-- <div class="card-header d-flex align-items-center justify-content-between gap-2 flex-wrap">
            <div class="d-flex align-items-center gap-2 flex-nowrap">
                <p-multiselect [options]="supervisors" [(ngModel)]="selectedSupervisorIds" optionLabel="supervisorName"
                    optionValue="id" placeholder="فلتر حسب المشرف" class="form-control" [filter]="true"
                    [showClear]="true" (onChange)="onSupervisorChange()" (onClear)="onSupervisorClear()"
                    [style]="{'min-width': '200px'}">
                </p-multiselect>
                <p-multiselect [options]="families" [(ngModel)]="selectedFamilyIds" optionLabel="familyName"
                    optionValue="id" placeholder="فلتر حسب العائلة" class="form-control" [filter]="true"
                    [showClear]="true" (onChange)="onFamilyChange()" (onClear)="onFamilyClear()"
                    [style]="{'min-width': '200px'}">
                </p-multiselect>
                <p-multiselect [options]="teachers" [(ngModel)]="selectedTeacherIds" optionLabel="teacherName"
                    optionValue="id" placeholder="فلتر حسب المعلم" class="form-control" [filter]="true"
                    [showClear]="true" (onChange)="onFilterChange()" [style]="{'min-width': '200px'}">
                </p-multiselect>
                <p-multiselect [options]="students" [(ngModel)]="selectedStudentIds" optionLabel="studentName"
                    optionValue="id" placeholder="فلتر حسب الطالب" class="form-control" [filter]="true"
                    [showClear]="true" (onChange)="onFilterChange()" [style]="{'min-width': '200px'}">
                </p-multiselect>
                <input type="text" class="form-control flex-shrink-0" bsDatepicker [(ngModel)]="fromDate"
                    (bsValueChange)="onFromDateChange()" placeholder="من تاريخ" style="width: 180px;">
                <input type="text" class="form-control flex-shrink-0" bsDatepicker [(ngModel)]="toDate"
                    (bsValueChange)="onToDateChange()" [disabled]="!fromDate" [bsConfig]="{ minDate: fromDate }"
                    placeholder="إلى تاريخ" style="width: 180px;">
                <button class="btn btn-outline-secondary btn-sm text-nowrap flex-shrink-0" *ngIf="hasActiveFilters()"
                    (click)="clearFilters()">
                    <i class="ti ti-x me-1"></i>مسح الفلاتر
                </button>
            </div>
        </div> -->
        <div class="card-body d-flex flex-column">
            <div *ngIf="lessons.length === 0" class="text-center py-5">
                <i class="ti ti-database-off fs-1 text-muted"></i>
                <p class="mt-2 text-muted">لم يتم العثور على دروس</p>
            </div>

            <div class="table-responsive table-container" *ngIf="lessons.length > 0">
                <table class="table table-striped mb-0" matSort (matSortChange)="sortData($event)">
                    <thead>
                        <tr>
                            <th mat-sort-header="studentName">الطالب</th>
                            <th mat-sort-header="teacherName">المعلم</th>
                            <th mat-sort-header="familyName">العائلة</th>
                            <th mat-sort-header="lessonDate">تاريخ الدرس</th>
                            <th mat-sort-header="durationMinutes">المدة (دقيقة)</th>
                            <th mat-sort-header="evaluation">التقييم</th>
                            <th>الإجراء</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let data of lessons">
                            <td>{{data.studentName}}</td>
                            <td>{{data.teacherName}}</td>
                            <td>{{data.familyName || '---'}}</td>
                            <td>{{data.lessonDate | date:'yyyy-MM-dd'}}</td>
                            <td>{{data.durationMinutes}}</td>
                            <td>
                                <span class="badge" [ngClass]="getEvaluationBadgeClass(data.evaluation)">
                                    {{getEvaluationLabel(data.evaluation)}}
                                </span>
                            </td>
                            <td>
                                <div class="dropdown table-action">
                                    <a href="javascript:void(0);"
                                        class="action-icon btn btn-xs shadow btn-icon btn-outline-light"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="ti ti-dots-vertical"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <a class="dropdown-item" href="javascript:void(0);" data-bs-toggle="offcanvas"
                                            data-bs-target="#offcanvas_edit" (click)="openEditModal(data.id)">
                                            <i class="ti ti-edit text-blue me-1"></i>تعديل
                                        </a>
                                        <a class="dropdown-item" href="javascript:void(0);" data-bs-toggle="modal"
                                            data-bs-target="#delete_lesson" (click)="openDeleteModal(data.id)">
                                            <i class="ti ti-trash text-blue me-1"></i>حذف
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <app-custom-pagination [rowCount]="rowCount" [pageNumber]="pageNumber" [pagesCount]="pagesCount"
                (pageChange)="onPageChange($event)">
            </app-custom-pagination>
        </div>
    </div>
</div>

<!-- Add Lesson Offcanvas -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="offcanvas_add" #offcanvasAdd>
    <div class="offcanvas-header border-bottom">
        <h5 class="fw-semibold">إضافة درس جديد</h5>
    </div>
    <div class="offcanvas-body">
        <form [formGroup]="lessonForm" (ngSubmit)="submitForm()">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">الطالب <span class="text-danger">*</span></label>
                    <p-select [options]="students" formControlName="studentId" optionLabel="studentName"
                        optionValue="id" placeholder="اختر الطالب" class="form-control w-100"
                        [filter]="true"></p-select>
                    <div class="text-danger mt-1" *ngIf="studentId.invalid && (studentId.dirty || studentId.touched)">
                        <small *ngIf="studentId.errors?.['required']">الطالب مطلوب.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">المعلم <span class="text-danger">*</span></label>
                    <p-select [options]="teachers" formControlName="teacherId" optionLabel="teacherName"
                        optionValue="id" placeholder="اختر المعلم" class="form-control w-100"
                        [filter]="true"></p-select>
                    <div class="text-danger mt-1" *ngIf="teacherId.invalid && (teacherId.dirty || teacherId.touched)">
                        <small *ngIf="teacherId.errors?.['required']">المعلم مطلوب.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">تاريخ الدرس <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" bsDatepicker formControlName="lessonDate"
                        placeholder="اختر تاريخ الدرس">
                    <div class="text-danger mt-1"
                        *ngIf="lessonDate.invalid && (lessonDate.dirty || lessonDate.touched)">
                        <small *ngIf="lessonDate.errors?.['required']">تاريخ الدرس مطلوب.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">مدة الدرس (بالدقائق) <span class="text-danger">*</span></label>
                    <p-select [options]="durationOptions" formControlName="durationMinutes" optionLabel="label"
                        optionValue="value" placeholder="اختر المدة" class="form-control w-100"></p-select>
                    <div class="text-danger mt-1"
                        *ngIf="durationMinutes.invalid && (durationMinutes.dirty || durationMinutes.touched)">
                        <small *ngIf="durationMinutes.errors?.['required']">مدة الدرس مطلوبة.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">التقييم</label>
                    <p-select [options]="evaluationOptions" formControlName="evaluation" optionLabel="label"
                        optionValue="value" placeholder="اختر التقييم" class="form-control w-100"></p-select>
                </div>

                <div class="col-12 mb-3">
                    <label class="form-label">ملاحظات</label>
                    <textarea class="form-control" formControlName="notes" rows="3" dir="auto"></textarea>
                </div>

                <div class="col-12 text-end mt-3">
                    <button type="button" class="btn btn-light mx-2" data-bs-dismiss="offcanvas">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ الدرس</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Lesson Offcanvas -->
<div class="offcanvas offcanvas-end offcanvas-large" tabindex="-1" id="offcanvas_edit" #offcanvasEdit>
    <div class="offcanvas-header border-bottom">
        <h5 class="fw-semibold">تعديل الدرس</h5>
    </div>
    <div class="offcanvas-body">
        <form [formGroup]="lessonForm" (ngSubmit)="submitForm()">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">الطالب <span class="text-danger">*</span></label>
                    <p-select [options]="students" formControlName="studentId" optionLabel="studentName"
                        optionValue="id" placeholder="اختر الطالب" class="form-control w-100"
                        [filter]="true"></p-select>
                    <div class="text-danger mt-1" *ngIf="studentId.invalid && (studentId.dirty || studentId.touched)">
                        <small *ngIf="studentId.errors?.['required']">الطالب مطلوب.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">المعلم <span class="text-danger">*</span></label>
                    <p-select [options]="teachers" formControlName="teacherId" optionLabel="teacherName"
                        optionValue="id" placeholder="اختر المعلم" class="form-control w-100"
                        [filter]="true"></p-select>
                    <div class="text-danger mt-1" *ngIf="teacherId.invalid && (teacherId.dirty || teacherId.touched)">
                        <small *ngIf="teacherId.errors?.['required']">المعلم مطلوب.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">تاريخ الدرس <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" bsDatepicker formControlName="lessonDate"
                        placeholder="اختر تاريخ الدرس">
                    <div class="text-danger mt-1"
                        *ngIf="lessonDate.invalid && (lessonDate.dirty || lessonDate.touched)">
                        <small *ngIf="lessonDate.errors?.['required']">تاريخ الدرس مطلوب.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">مدة الدرس (بالدقائق) <span class="text-danger">*</span></label>
                    <p-select [options]="durationOptions" formControlName="durationMinutes" optionLabel="label"
                        optionValue="value" placeholder="اختر المدة" class="form-control w-100"></p-select>
                    <div class="text-danger mt-1"
                        *ngIf="durationMinutes.invalid && (durationMinutes.dirty || durationMinutes.touched)">
                        <small *ngIf="durationMinutes.errors?.['required']">مدة الدرس مطلوبة.</small>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">التقييم</label>
                    <p-select [options]="evaluationOptions" formControlName="evaluation" optionLabel="label"
                        optionValue="value" placeholder="اختر التقييم" class="form-control w-100"></p-select>
                </div>

                <div class="col-12 mb-3">
                    <label class="form-label">ملاحظات</label>
                    <textarea class="form-control" formControlName="notes" rows="3" dir="auto"></textarea>
                </div>

                <div class="col-12 text-end mt-3">
                    <button type="button" class="btn btn-light mx-2" data-bs-dismiss="offcanvas">إلغاء</button>
                    <button type="submit" class="btn btn-primary" [disabled]="lessonForm.invalid">تحديث الدرس</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="delete_lesson">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <span class="avatar avatar-xl badge-soft-danger border-0 text-danger rounded-circle">
                        <i class="ti ti-trash fs-24"></i>
                    </span>
                </div>
                <h5 class="mb-1">تأكيد الحذف</h5>
                <p class="mb-3">هل أنت متأكد أنك تريد حذف هذا الدرس؟</p>
                <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-sm btn-light me-2 w-100" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-sm btn-primary w-100" data-bs-dismiss="modal"
                        (click)="onDeleteLesson()">نعم، احذف</button>
                </div>
            </div>
        </div>
    </div>
</div>